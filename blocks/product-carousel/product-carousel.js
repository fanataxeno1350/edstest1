import { createOptimizedPicture } from '../../scripts/aem.js';
import { moveInstrumentation } from '../../scripts/scripts.js';

export default function decorate(block) {
  const titleElement = block.querySelector('h1, h2, h3, h4, h5, h6');
  const productCarouselBox = document.createElement('div');
  productCarouselBox.classList.add('product-carousel-box');

  if (titleElement) {
    const h2 = document.createElement('h2');
    h2.classList.add('product-carousel-white');
    h2.textContent = titleElement.textContent;
    productCarouselBox.append(h2);
    moveInstrumentation(titleElement, h2);
  }

  const productCarouselBxWrapper = document.createElement('div');
  productCarouselBxWrapper.classList.add('product-carousel-bx-wrapper');

  const productCarouselBxViewport = document.createElement('div');
  productCarouselBxViewport.classList.add('product-carousel-bx-viewport');

  const productCarouselBxslider = document.createElement('ul');
  productCarouselBxslider.classList.add('product-carousel-bxslider');

  const productItems = Array.from(block.querySelectorAll('[data-aue-model="product"]'));

  productItems.forEach((itemNode) => {
    const li = document.createElement('li');
    const imageField = itemNode.querySelector('[data-aue-prop="image"]');
    const titleField = itemNode.querySelector('[data-aue-prop="title"]');
    const descriptionField = itemNode.querySelector('[data-aue-prop="description"]');
    const readMoreLinkField = itemNode.querySelector('[data-aue-prop="readMoreLink"]');
    const disclaimerField = itemNode.querySelector('[data-aue-prop="disclaimer"]');

    const figure = document.createElement('figure');
    if (imageField) {
      const img = imageField.querySelector('img');
      if (img) {
        figure.append(createOptimizedPicture(img.src, img.alt));
        moveInstrumentation(img, figure.querySelector('picture'));
      }
    }
    li.append(figure);

    const productCarouselDtl = document.createElement('div');
    productCarouselDtl.classList.add('product-carousel-dtl');

    if (titleField) {
      const h1 = document.createElement('h1');
      h1.textContent = titleField.textContent;
      productCarouselDtl.append(h1);
      moveInstrumentation(titleField, h1);
    }

    if (descriptionField) {
      const pOrUl = descriptionField.querySelector('p, ul');
      if (pOrUl) {
        if (pOrUl.tagName === 'P') {
          pOrUl.classList.add('product-carousel-font-weight-100');
        } else if (pOrUl.tagName === 'UL') {
          productCarouselDtl.classList.add('product-carousel-bulletPoints');
          const br = document.createElement('br');
          productCarouselDtl.append(br);
        }
        productCarouselDtl.append(pOrUl);
        moveInstrumentation(descriptionField, pOrUl);
      }
    }

    if (readMoreLinkField) {
      const anchor = readMoreLinkField.querySelector('a');
      if (anchor) {
        anchor.classList.add('product-carousel-r-more');
        productCarouselDtl.append(anchor);
        moveInstrumentation(readMoreLinkField, anchor);
      }
    }

    // Handle potential 'Buy Now' span, assuming it's also within readMoreLinkField or a sibling
    const buyNowSpan = itemNode.querySelector('.product-carousel-r-more[onclick]');
    if (buyNowSpan) {
      productCarouselDtl.append(buyNowSpan);
      moveInstrumentation(buyNowSpan, buyNowSpan);
    }

    li.append(productCarouselDtl);

    if (disclaimerField) {
      const productCarouselDis = document.createElement('div');
      productCarouselDis.classList.add('product-carousel-dis');
      const productCarouselItemList = document.createElement('div');
      productCarouselItemList.classList.add('product-carousel-item-list');
      const ul = document.createElement('ul');
      const liDisclaimer = document.createElement('li');
      liDisclaimer.classList.add('product-carousel-first', 'product-carousel-last');
      liDisclaimer.textContent = disclaimerField.textContent;
      ul.append(liDisclaimer);
      productCarouselItemList.append(ul);
      productCarouselDis.append(productCarouselItemList);
      li.append(productCarouselDis);
      moveInstrumentation(disclaimerField, liDisclaimer);
    }

    productCarouselBxslider.append(li);
    moveInstrumentation(itemNode, li);
  });

  productCarouselBxViewport.append(productCarouselBxslider);
  productCarouselBxWrapper.append(productCarouselBxViewport);

  // Add static pager and controls as per the HTML structure
  const productCarouselBxControls = document.createElement('div');
  productCarouselBxControls.classList.add('product-carousel-bx-controls', 'product-carousel-bx-has-pager', 'product-carousel-bx-has-controls-direction');

  const productCarouselBxPager = document.createElement('div');
  productCarouselBxPager.classList.add('product-carousel-bx-pager', 'product-carousel-bx-default-pager');
  // Pager items are dynamically generated by the carousel script, so we'll add placeholders
  // For EDS, we can just add a few dummy ones or skip if they are purely client-side generated
  for (let i = 0; i < Math.min(productItems.length, 5); i += 1) { // Limit to 5 for example
    const pagerItem = document.createElement('div');
    pagerItem.classList.add('product-carousel-bx-pager-item');
    const pagerLink = document.createElement('a');
    pagerLink.setAttribute('href', '');
    pagerLink.setAttribute('data-slide-index', i);
    pagerLink.classList.add('product-carousel-bx-pager-link');
    if (i === 1) pagerLink.classList.add('product-carousel-active'); // Example active state
    pagerLink.textContent = i + 1;
    pagerItem.append(pagerLink);
    productCarouselBxPager.append(pagerItem);
  }
  productCarouselBxControls.append(productCarouselBxPager);

  const productCarouselBxControlsDirection = document.createElement('div');
  productCarouselBxControlsDirection.classList.add('product-carousel-bx-controls-direction');

  const prevLink = document.createElement('a');
  prevLink.classList.add('product-carousel-bx-prev');
  prevLink.setAttribute('href', '');
  prevLink.textContent = 'Prev';
  productCarouselBxControlsDirection.append(prevLink);

  const nextLink = document.createElement('a');
  nextLink.classList.add('product-carousel-bx-next');
  nextLink.setAttribute('href', '');
  nextLink.textContent = 'Next';
  productCarouselBxControlsDirection.append(nextLink);

  productCarouselBxControls.append(productCarouselBxControlsDirection);
  productCarouselBxWrapper.append(productCarouselBxControls);

  productCarouselBox.append(productCarouselBxWrapper);

  block.textContent = '';
  block.append(productCarouselBox);
  block.className = `product-carousel block`;
  block.dataset.blockStatus = 'loaded';
}
